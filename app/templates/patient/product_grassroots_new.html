{% extends "base.html" %}
{% block title %}Submit a Product | Kushwell Care{% endblock %}

{% block content %}
<div class="kw-container">
  <form class="kw-card" method="post" action="{{ url_for('patient.product_grassroots_new') }}" enctype="multipart/form-data" style="padding:16px;">
    {{ csrf_token() }}
    <input type="hidden" name="next" value="{{ next_url or url_for('patient.wellness_checkin') }}">

    <h1 class="kw-tight" style="margin:0 0 8px 0;">Grassroots: Submit a Product</h1>
    <p class="kw-meta" style="margin:0 0 12px 0;">
      Help the community by submitting a product. We’ll review and publish it.
    </p>

    <div class="kw-grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px;">

      <!-- Name (prefilled from ?q=) -->
      <label>
        <span class="kw-meta">Name *</span>
        <input class="kw-input" type="text" name="name" required
               placeholder="e.g., Gelato Live Resin Cart"
               value="{{ prefill_name or '' }}">
      </label>

      <!-- Brand -->
      <label>
        <span class="kw-meta">Brand</span>
        <input class="kw-input" type="text" name="brand" placeholder="Brand name">
      </label>

      <!-- Classification -->
      <label>
        <span class="kw-meta">Classification *</span>
        <select class="kw-input" name="classification" required>
          {% for c in classifications or ['Indica','Sativa','Hybrid','N/A','Unknown'] %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Application Method (dropdown) -->
      <label>
        <span class="kw-meta">Application Method</span>
        <select class="kw-input" name="application_method">
          {% for m in application_methods or [] %}
            {% if m is string %}
              <option value="{{ m }}">{{ m }}</option>
            {% else %}
              <option value="{{ m[0] }}">{{ m[1] if m|length > 1 else m[0] }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </label>

      <!-- Primary Affliction (dropdown) -->
      <label>
        <span class="kw-meta">Primary Affliction</span>
        <select class="kw-input" name="affliction">
          <option value="">(None)</option>
          {% for item in afflictions_list or [] %}
            <option value="{{ item }}">{{ item }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Potency -->
      <label>
        <span class="kw-meta">THC %</span>
        <input class="kw-input" type="number" step="0.1" min="0" max="100" inputmode="decimal" name="thc_pct" placeholder="e.g., 23.5">
      </label>
      <label>
        <span class="kw-meta">CBD %</span>
        <input class="kw-input" type="number" step="0.1" min="0" max="100" inputmode="decimal" name="cbd_pct" placeholder="e.g., 0.5">
      </label>

      <!-- Description -->
      <label style="grid-column:1/-1;">
        <span class="kw-meta">Description</span>
        <textarea class="kw-textarea" rows="4" name="description" placeholder="Notes, effects, flavor…"></textarea>
      </label>

      <!-- Image -->
      <label style="grid-column:1/-1;">
        <span class="kw-meta">Product Image</span>
        <input class="kw-input" type="file" name="image" accept="image/*">
      </label>
    </div>

    <hr style="margin:14px 0; border-color:rgba(255,255,255,0.2)">

    {# ---- Terpenes (chips + AUTOFILL) ---- #}
    <section>
      <h2 class="kw-card__title" style="margin:0 0 8px 0;">Terpenes</h2>
      <div class="kw-row kw-gap" style="flex-wrap:wrap; align-items:end;">
        <label>
          <span class="kw-meta">Terpene Name</span>
          <input class="kw-input" type="text" id="tName" placeholder="Start typing…" list="terpeneMaster" autocomplete="off">
          <datalist id="terpeneMaster">
            {% for t in terpenes_master or [] %}
              <option value="{{ t }}"></option>
            {% endfor %}
          </datalist>
        </label>
        <label>
          <span class="kw-meta">% by weight</span>
          <input class="kw-input" type="number" id="tPct" step="0.01" min="0" max="100" inputmode="decimal" placeholder="e.g., 0.82">
        </label>
        <button type="button" class="kw-btn" id="tAdd">Add Terpene</button>
      </div>

      <div class="kw-meta" style="margin-top:6px;">
        Type to autofill from the master list. Non-listed entries will be marked as “custom”.
      </div>

      <div id="terpList" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;"></div>
    </section>

    <div class="kw-card__actions" style="margin-top:14px; display:flex; gap:10px;">
      <button class="kw-btn" type="submit">Submit for Review</button>
      <a class="kw-btn kw-btn--ghost" href="{{ next_url or url_for('patient.wellness_checkin') }}">Cancel</a>
    </div>
  </form>
</div>

<script>
(function(){
  // Build a JS Set for fast validation of terpene names
  const TERPENES = new Set(({{ (terpenes_master or [])|tojson }} || []).map(String));

  const list = document.getElementById('terpList');
  const tName = document.getElementById('tName');
  const tPct  = document.getElementById('tPct');
  const tAdd  = document.getElementById('tAdd');

  function addTerp(nm, pct){
    const name = (nm || '').trim();
    const val  = (pct || '').trim();
    if(!name || !val) return;

    const isKnown = TERPENES.has(name);
    const wrap = document.createElement('div');
    wrap.className = 'kw-chip';
    wrap.style.cssText = 'display:flex;align-items:center;gap:6px;border:1px solid rgba(0,0,0,0.25);border-radius:999px;padding:6px 10px;background:#fff;color:#111;';
    wrap.innerHTML = `
      <span>${name}</span>
      <span class="kw-tag">${val}%</span>
      ${isKnown ? '' : '<span class="kw-tag" title="Not in master list">custom</span>'}
      <button type="button" class="kw-btn kw-btn--ghost" aria-label="Remove" style="padding:.2rem .6rem;">×</button>
      <input type="hidden" name="terpene_name[]" value="${name}">
      <input type="hidden" name="terpene_pct[]"  value="${val}">
    `;
    wrap.querySelector('button').addEventListener('click', ()=> wrap.remove());
    list.appendChild(wrap);
  }

  tAdd.addEventListener('click', ()=> {
    addTerp(tName.value, tPct.value);
    tName.value = ''; tPct.value='';
  });

  tName.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); tPct.focus(); }});
  tPct.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); tAdd.click(); }});
})();
</script>
{% endblock %}


